'''
(allele FBal0360704)
(allele_symbol (allele FBal0360704) Ecol\\lacZ[Mef2-3046])
(gene (allele FBal0360704) FBgn0014447)
(taxon_id (allele FBal0360704) 7227)

(allele_genetic_interaction allele_genetic_interaction_0)
(allele_id (allele_genetic_interaction allele_genetic_interaction_0) FBal0194587)
(interaction_text (allele_genetic_interaction allele_genetic_interaction_0) 5-HT1A[Î”5kb]_has_abnormal_behavior_phenotype,_non-suppressible_by_Scer\\GAL4[Mef2.24
7.Switch]/5-HT1B[UAS.cYa])
(reference (allele_genetic_interaction allele_genetic_interaction_0) FBrf0195242)

(dmel_disease_model dmel_disease_model_93)
(taxon_id (dmel_disease_model dmel_disease_model_93) 7227)
(gene (dmel_disease_model dmel_disease_model_93) FBgn0283831)
(gene_hgnc_id (dmel_disease_model dmel_disease_model_93) HGNC:15924)
(do_qualifier (dmel_disease_model dmel_disease_model_93) model_of)
(do_term_id (dmel_disease_model dmel_disease_model_93) DOID:305)
(do_term_name (dmel_disease_model dmel_disease_model_93) carcinoma)
(allele (dmel_disease_model dmel_disease_model_93) FBal0320822)
(interacting_alleles (dmel_disease_model dmel_disease_model_93) FBal0093088)
(ev_code_interact_alleles (dmel_disease_model dmel_disease_model_93) is_ameliorated_by_FLYBASE:Myc[UAS.cZa];_FB:FBal0093088)
(reference_id (dmel_disease_model dmel_disease_model_93) FBrf0245231))

(gene_genetic_association (gene FBgn0262656) (gene FBgn0037363))
(type (gene_genetic_association (gene FBgn0262656) (gene FBgn0037363)) suppressible)
(reference (gene_genetic_association (gene FBgn0262656) (gene FBgn0037363)) FBrf0222430)
(taxon_id (gene_genetic_association (gene FBgn0262656) (gene FBgn0037363)) 7227)

(gene_group FBgg0001425)
(genes (gene_group FBgg0001425) FBgn0266100)
(genes (gene_group FBgg0001425) FBgn0261804)
(genes (gene_group FBgg0001425) FBgn0039420)
(genes (gene_group FBgg0001425) FBgn0266100)
(genes (gene_group FBgg0001425) FBgn0261804)
(genes (gene_group FBgg0001425) FBgn0039420)
(group_symbol (gene_group FBgg0001425) M19P)
(group_name (gene_group FBgg0001425) M19_METALLODIPEPTIDASES)
(parent_groups (gene_group FBgg0001425) FBgg0001400)
(parent_groups (gene_group FBgg0001425) FBgg0001522)
(HGNC_family_ID (gene_group FBgg0001425) 1445)
(taxon_id (gene_group FBgg0001425) 7227)
(source (gene_group FBgg0001425) FLYBASE)
(source_url (gene_group FBgg0001425) https://flybase.org/)

(genotype_phenotype FBal0231618@FBal0288220)                @  <<<<<<------------------------------------------------------------------------------
(genotype_symbols (genotype_phenotype FBal0231618@FBal0288220) ACC[KK102082]@Scer\\GAL4[Mef2.PU])
(phenotype_name (genotype_phenotype FBal0231618@FBal0288220) viable)
(phenotype_id (genotype_phenotype FBal0231618@FBal0288220) FBcv:0000349)
(reference (genotype_phenotype FBal0231618@FBal0288220) FBrf0227628)
(taxon_id (genotype_phenotype FBal0231618@FBal0288220) 7227)

(genotype_phenotype FBal0028656)
(genotype_symbols (genotype_phenotype FBal0028656) Abd-B[Fab7-1])
(phenotype_name (genotype_phenotype FBal0028656) parasegment_11)
(phenotype_id (genotype_phenotype FBal0028656) FBbt:00000149)
(qualifier_names (genotype_phenotype FBal0028656) embryonic_stage)
(qualifier_ids (genotype_phenotype FBal0028656) FBdv:00005289)
(reference (genotype_phenotype FBal0028656) FBrf0074694)
(taxon_id (genotype_phenotype FBal0028656) 7227)

(pathway_gene_group FBgg0001091)
(taxon_id (pathway_gene_group FBgg0001091) 7227)
(genes (pathway_gene_group FBgg0001091) FBgn0259878)
(genes (pathway_gene_group FBgg0001091) FBgn0262323)
(group_symbol (pathway_gene_group FBgg0001091) ACT-N)
(group_name (pathway_gene_group FBgg0001091) Negative_Regulators_of_Activin_Signaling_Pathway)
(parent_groups (pathway_gene_group FBgg0001091) FBgg0001093)
(source (pathway_gene_group FBgg0001091) FLYBASE)
(source_url (pathway_gene_group FBgg0001091) https://flybase.org/)

(belongs_to (gene FBgn0000015) (go GO:0007621))
(qualifier (belongs_to (gene FBgn00000      115) (go GO:0007621)) involved_in)
(db_reference (belongs_to (gene FBgn0000015) (go GO:0007621)) FB:FBrf0221166)
(db_reference (belongs_to (gene FBgn0000015) (go GO:0007621)) PMID:23555301)
(evidence (belongs_to (gene FBgn0000015) (go GO:0007621)) IMP)
(taxon (belongs_to (gene FBgn0000015) (go GO:0007621)) 7227)
(source (belongs_to (gene FBgn0000015) (go GO:0007621)) GO)
(source_url (belongs_to (gene FBgn0000015) (go GO:0007621)) https://ftp.flybase.net/releases/current/precomputed_files/go/gene_association.fb.gz)

(transcribed_from (transcript FBtr0076785) (gene FBgn0023076))
(taxon_id (transcribed_from (transcript FBtr0076785) (gene FBgn0023076)) 7227)
(source (transcribed_from (transcript FBtr0076785) (gene FBgn0023076)) GENCODE)
(source_url (transcribed_from (transcript FBtr0076785) (gene FBgn0023076)) https://www.gencodegenes.org/human/)

(transcribed_to (gene FBgn0023076) (transcript FBtr0100132))
(taxon_id (transcribed_to (gene FBgn0023076) (transcript FBtr0100132)) 7227)
(source (transcribed_to (gene FBgn0023076) (transcript FBtr0100132)) GENCODE)
(source_url (transcribed_to (gene FBgn0023076) (transcript FBtr0100132)) https://www.gencodegenes.org/human/)


(exon FBtr0083383-E4)
(gene (exon FBtr0083383-E4) FBgn0000015)
(transcript (exon FBtr0083383-E4) FBtr0083383)
(chr (exon FBtr0083383-E4) 3R)
(start (exon FBtr0083383-E4) 16931402)
(end (exon FBtr0083383-E4) 16931613)
(exon_number (exon FBtr0083383-E4) 4)
(taxon_id (exon FBtr0083383-E4) 7227)
(source (exon FBtr0083383-E4) GENCODE)
(source_url (exon FBtr0083383-E4) https://www.gencodegenes.org/human/)

(gene FBgn0023076)
(gene_type (gene FBgn0023076) protein_coding)
(chr (gene FBgn0023076) 3L)
(start (gene FBgn0023076) 7763233)
(end (gene FBgn0023076) 7775603)
(gene_name (gene FBgn0023076) Clk)
(synonyms (gene FBgn0023076) Clk-PD)
(synonyms (gene FBgn0023076) CLK)
(synonyms (gene FBgn0023076) CG7391-PD)
(synonyms (gene FBgn0023076) dclk)
(synonyms (gene FBgn0023076) CG7391-PG)
(synonyms (gene FBgn0023076) dClock)
(synonyms (gene FBgn0023076) CLOCK)
(synonyms (gene FBgn0023076) Clk-PG)
(synonyms (gene FBgn0023076) clock)
(synonyms (gene FBgn0023076) dClck)
(synonyms (gene FBgn0023076) Clk-PA)
(synonyms (gene FBgn0023076) Clk-PF)
(synonyms (gene FBgn0023076) dCLK)
(synonyms (gene FBgn0023076) CG7391-PH)
(synonyms (gene FBgn0023076) Clock)
(synonyms (gene FBgn0023076) Dmel\\CG7391)
(synonyms (gene FBgn0023076) Clk)
(synonyms (gene FBgn0023076) Jrk)
(synonyms (gene FBgn0023076) jrk)
(synonyms (gene FBgn0023076) dClk)
(synonyms (gene FBgn0023076) dCLOCK)
(synonyms (gene FBgn0023076) dCLK/JRK)
(synonyms (gene FBgn0023076) CG7391-PA)
(synonyms (gene FBgn0023076) Clk-PH)
(synonyms (gene FBgn0023076) CG7391-PF)
(synonyms (gene FBgn0023076) CG7391)
(synonyms (gene FBgn0023076) Jerk)
(synonyms (gene FBgn0023076) bHLHe10)
(synonyms (gene FBgn0023076) PAS1)
(synonyms (gene FBgn0023076) clk)
(taxon_id (gene FBgn0023076) 7227)
(summary_source (gene FBgn0023076) UniProtKB)
(summary (gene FBgn0023076) Circadian_regulator_that_acts_as_a_transcription_factor_and_generates_a_rhythmic_output_with_a_period_of_about_24_hours._Oscillates_in_antiphase_to_the_cycling_observed_for_period_\(PER\)_and_timeless_\(TIM\)._According_to_PubMed:9742131,_reaches_peak_abundance_within_several_hours_of_the_dark-light_transition_at_ZT0_\(zeitgeber_0\),_whereas_PubMed:9616122_describes_bimodal_oscillating_expression_with_maximum_at_ZT5_and_ZT23._Clock-cycle_heterodimers_activate_cycling_transcription_of_PER_and_TIM_by_binding_to_the_E-box_\(5'-CACGTG-3'\)_present_in_their_promoters._Once_induced,_Period_and_Timeless_block_Clock's_ability_to_transactivate_their_promoters._\(UniProtKB:O61735\))
(source (gene FBgn0023076) GENCODE)
(source_url (gene FBgn0023076) https://www.gencodegenes.org/human/)
'''
(source (gene FBgn0038655) GENCODE)
(source_url (gene FBgn0038655) https://www.gencodegenes.org/human/)
'''

(transcript FBtr0415465)
(gene (transcript FBtr0415465) FBgn0000015)
(transcript_name (transcript FBtr0415465) Abd-B-RJ)
(transcript_type (transcript FBtr0415465) protein_coding)
(chr (transcript FBtr0415465) 3R)
(start (transcript FBtr0415465) 16927667)
(end (transcript FBtr0415465) 16968574)
(taxon_id (transcript FBtr0415465) 7227)
(source (transcript FBtr0415465) GENCODE)
(source_url (transcript FBtr0415465) https://www.gencodegenes.org/human/)

(go GO:2001050)
(term_name (go GO:2001050) negative_regulation_of_tendon_cell_differentiation)
(synonyms (go GO:2001050) negative_regulation_of_tenocyte_differentiation)
(synonyms (go GO:2001050) negative_regulation_of_muscle_attachment_cell_differentiation)
(source (go GO:2001050) Gene_Ontology)
(source_url (go GO:2001050) http://purl.obolibrary.org/obo/go.owl)
(subontology (go GO:2001050) biological_process)

(orthologs_genes (gene FBgn0262656) (gene ENSG00000134323))
(hsa_hgnc_id (orthologs_genes (gene FBgn0262656) (gene ENSG00000134323)) HGNC:7559)
(hsa_omim_id (orthologs_genes (gene FBgn0262656) (gene ENSG00000134323)) MIM:164840)
(hsa_hgnc_symbol (orthologs_genes (gene FBgn0262656) (gene ENSG00000134323)) MYCN)
(DIOPT_score (orthologs_genes (gene FBgn0262656) (gene ENSG00000134323)) 3)
(hsa_omim_phenotype_ids (orthologs_genes (gene FBgn0262656) (gene ENSG00000134323)) 164280,620748)
(hsa_omim_phenotype_ids_names (orthologs_genes (gene FBgn0262656) (gene ENSG00000134323)) 164280[FEINGOLD_SYNDROME_1;_FGLDS1],620748[MEGALENCEPHALY-POLYDACTYLY_
SYNDROME;_MPAPA])
(source_organism (orthologs_genes (gene FBgn0262656) (gene ENSG00000134323)) Drosophila_melanogaster)
(target_organism (orthologs_genes (gene FBgn0262656) (gene ENSG00000134323)) Homo_sapiens)

(paralogs_genes (gene FBgn0261630) (gene FBgn0038654))
(source_symbol (paralogs_genes (gene FBgn0261630) (gene FBgn0038654)) CG42713)
(target_symbol (paralogs_genes (gene FBgn0261630) (gene FBgn0038654)) CG14298)
(DIOPT_score (paralogs_genes (gene FBgn0261630) (gene FBgn0038654)) 1)
(taxon_id (paralogs_genes (gene FBgn0261630) (gene FBgn0038654)) 7227)

(parent_pathway_of (pathway R-DME-1483206) (pathway R-DME-1483226))
(source (parent_pathway_of (pathway R-DME-1483206) (pathway R-DME-1483226)) REACTOME)
(source_url (parent_pathway_of (pathway R-DME-1483206) (pathway R-DME-1483226)) https://reactome.org)
(taxon_id (parent_pathway_of (pathway R-DME-1483206) (pathway R-DME-1483226)) 7227)

(parent_pathway_of (pathway R-DME-1483206) (pathway R-DME-1483226))
(source (parent_pathway_of (pathway R-DME-1483206) (pathway R-DME-1483226)) REACTOME)
(source_url (parent_pathway_of (pathway R-DME-1483206) (pathway R-DME-1483226)) https://reactome.org)
(taxon_id (parent_pathway_of (pathway R-DME-1483206) (pathway R-DME-1483226)) 7227)

(child_pathway_of (pathway R-DME-8864260) (pathway R-DME-212436))
(source (child_pathway_of (pathway R-DME-8864260) (pathway R-DME-212436)) REACTOME)
(source_url (child_pathway_of (pathway R-DME-8864260) (pathway R-DME-212436)) https://reactome.org)
(taxon_id (child_pathway_of (pathway R-DME-8864260) (pathway R-DME-212436)) 7227)

(interacts_with (protein CTNA) (protein MEF2))
(score (interacts_with (protein CTNA) (protein MEF2)) 0.534)
(source (interacts_with (protein CTNA) (protein MEF2)) STRING)
(source_url (interacts_with (protein CTNA) (protein MEF2)) https://string-db.org/)
(taxon_id (interacts_with (protein CTNA) (protein MEF2)) 7227)

(regulates (gene FBgn0001291) (gene FBgn0010909))
(evidence (regulates (gene FBgn0001291) (gene FBgn0010909)) pubmed:20965965)
(evidence (regulates (gene FBgn0001291) (gene FBgn0010909)) pubmed:19641625)
(databases (regulates (gene FBgn0001291) (gene FBgn0010909)) REDfly)
(evidence_type (regulates (gene FBgn0001291) (gene FBgn0010909)) small_scale_evidence)
(detection_method (regulates (gene FBgn0001291) (gene FBgn0010909)) electrophoretic_mobility_shift_assay)
(source (regulates (gene FBgn0001291) (gene FBgn0010909)) TFLink)
(source_url (regulates (gene FBgn0001291) (gene FBgn0010909)) tflink.net)
(taxon_id (regulates (gene FBgn0001291) (gene FBgn0010909)) 7227)

(translation_of (protein P36179) (transcript FBtr0005088))
(source (translation_of (protein P36179) (transcript FBtr0005088)) Uniprot)
(source_url (translation_of (protein P36179) (transcript FBtr0005088)) https://www.uniprot.org/)
(taxon_id (translation_of (protein P36179) (transcript FBtr0005088)) 7227)

(translation_of (protein P36179) (transcript FBtr0100533))
(source (translation_of (protein P36179) (transcript FBtr0100533)) Uniprot)
(source_url (translation_of (protein P36179) (transcript FBtr0100533)) https://www.uniprot.org/)
(taxon_id (translation_of (protein P36179) (transcript FBtr0100533)) 7227)j

'''

from hyperon_das import DistributedAtomSpace
import time
import psycopg2

host = '127.0.0.1'
port = '8080'

das = DistributedAtomSpace(query_engine='remote', host=host, port=port)
#DistributedAtomSpace().about()

print(f"Connected to DAS at {host}:{port}")
print("(nodes, links) =", das.count_atoms({'precise': True}))


'''
Only for net_act because some gene symbols are not in DAS. So get them from Flybase.

'''
def get_symbol_from_flybase(fbgn:str) -> str:
    query_reg = f"SELECT name FROM feature WHERE uniquename = '{fbgn}' AND is_obsolete = 'f';"

    # Establish a connection to the FlyBase database
    conn = psycopg2.connect(
        host="chado.flybase.org",
        database="flybase",
        user="flybase"
    )    
    cur = conn.cursor()
    cur.execute(query_reg)
    results = cur.fetchall() 
    return results[0]


def get_all_FBgn():
    q = {
        "atom_type": "link",
        "type": "Expression",
        "targets": [
            {"atom_type": "node", "type": "Symbol", "name": "gene_name"},
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "gene"},
                    {"atom_type": "variable", "name": "v1"},
                ]
            },
            {"atom_type": "variable", "name": "v2"},
        ]
    }
    answer = das.query(q)
    # print(answer)
    fbgn_list = []
    for result in answer:
        #fbgn_list.append(result.subgraph['targets'][1]['targets'][1]['name'])
        fbgn_list.append(result.subgraph['targets'][2]['name'])

    # #assert (len(fbgn_list)) == 1
    # #print(f"More than one FBgn# for {gene_symbol}")
    return fbgn_list

# start = time.time()
# print(get_all_FBgn())
# finish = time.time()
# print(f'Answer time: {finish - start} sec.')
# exit(9)


def get_all_group_genes_fbgn():
    q = {
        "atom_type": "link",
        "type": "Expression",
        "targets": [
            {"atom_type": "node", "type": "Symbol", "name": "genes"},
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "gene_group"},
                    {"atom_type": "variable", "name": "v2"},
                ]
            },
            #{"atom_type": "node", "type": "Symbol", "name": "FBgn0032464"},
            {"atom_type": "variable", "name": "v1"},
        ]
    }
    answer = das.query(q)
    fbgn_list = []
    for result in answer:
        fbgn_list.append(result.subgraph['targets'][2]['name'])
        #fbgn_list.append(result.subgraph['targets'][1]['targets'][1]['name'])

    return fbgn_list

start = time.time()
print(len(set(get_all_group_genes_fbgn())))
finish = time.time()
print(f'Answer time: {finish - start} sec.')
# exit(9)

'''
Get the gene id (Flybase FBgn) given a gene symbol (name)

MeTTa:
(gene FBgn0000015)
(gene_type (gene FBgn0000015) protein_coding)
(chr (gene FBgn0000015) 3R)
(start (gene FBgn0000015) 16927212)
(end (gene FBgn0000015) 16972236)
(gene_name (gene FBgn0000015) Abd-B)
(synonyms (gene FBgn0000015) microcephalus)
(synonyms (gene FBgn0000015) pH189)
(synonyms (gene FBgn0000015) Abdb)
'''
def get_FBgn(gene_symbol: str):
    q = {
        "atom_type": "link",
        "type": "Expression",
        "targets": [
            {"atom_type": "node", "type": "Symbol", "name": "gene_name"},
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "gene"},
                    {"atom_type": "variable", "name": "v1"},
                ]
            },
            {"atom_type": "node", "type": "Symbol", "name": gene_symbol}             
        ]
    }
    answer = das.query(q)
    fbgn_list = []
    for result in answer:
        fbgn_list.append(result.subgraph['targets'][1]['targets'][1]['name'])

    #assert (len(fbgn_list)) == 1
    #print(f"More than one FBgn# for {gene_symbol}")
    return fbgn_list



'''
Explores the MeTTa structure to get any entity that is declared this way:

(query_property_name (main_entity_type main_entity_id) query_property_value)

For instance:
Example 1)
(genes (gene_group FBgg0001558) FBgn0032464)
(genes (gene_group FBgg0001558) FBgn0263598)
(genes (gene_group FBgg0001558) FBgn0265262)
(genes (gene_group FBgg0001558) FBgn0032464)
(genes (gene_group FBgg0001558) FBgn0263598)
(genes (gene_group FBgg0001558) FBgn0265262)
(group_symbol (gene_group FBgg0001558) VHA-V1-CAT)
(group_name (gene_group FBgg0001558) VACUOLAR_ATPASE_V1_DOMAIN_CATALYTIC_SUBUNITS)

Example 2)
(gene_type (gene FBgn0000015) protein_coding)
(chr (gene FBgn0000015) 3R)
(start (gene FBgn0000015) 16927212)
(end (gene FBgn0000015) 16972236)
(gene_name (gene FBgn0000015) Abd-B)
(synonyms (gene FBgn0000015) microcephalus)
(synonyms (gene FBgn0000015) pH189)
(synonyms (gene FBgn0000015) Abdb)

Returns:
    query_property_value, str, inside a list (to be consistent when multiple values are present: 
    "genes" or "synonyms" properties in examples 1 and 2), i.e, list[str]
'''
def get_property_value(query_property_name: str, 
                            main_entity_type: str, main_entity_id: str) -> list[str]:
    q = {
        "atom_type": "link",
        "type": "Expression",
        "targets": [
            {"atom_type": "node", "type": "Symbol", "name": query_property_name},
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": main_entity_type},
                    {"atom_type": "node", "type": "Symbol", "name": main_entity_id} 
                ]
            },
            {"atom_type": "variable", "name": "v1"},  # symbol
        ]
    }
    answer = das.query(q)
    query_property_value = []
    for result in answer:
        query_property_value.append(result.subgraph['targets'][2]['name'])

    return query_property_value


'''
Gets the gene symbol (name) for a given gene id (Flybase FBgn)

MeTTa:
(gene FBgn0000015)
(gene_type (gene FBgn0000015) protein_coding)
(chr (gene FBgn0000015) 3R)
(start (gene FBgn0000015) 16927212)
(end (gene FBgn0000015) 16972236)
(gene_name (gene FBgn0000015) Abd-B)
(synonyms (gene FBgn0000015) microcephalus)
(synonyms (gene FBgn0000015) pH189)
(synonyms (gene FBgn0000015) Abdb)
'''
def get_gene_symbol(fbgn: str):
    return get_property_value("gene_name", "gene", fbgn)

    # q = {
    #     "atom_type": "link",
    #     "type": "Expression",
    #     "targets": [
    #         {"atom_type": "node", "type": "Symbol", "name": "gene_name"},
    #         {
    #             "atom_type": "link",
    #             "type": "Expression",
    #             "targets": [
    #                 {"atom_type": "node", "type": "Symbol", "name": "gene"},
    #                 {"atom_type": "node", "type": "Symbol", "name": fbgn}                                 
    #             ]
    #         },
    #         {"atom_type": "variable", "name": "v1"},
    #     ]
    # }
    # answer = das.query(q)
    # symbols_list = []
    # for result in answer:
    #     symbols_list.append(result.subgraph['targets'][2]["name"])

    # return symbols_list


'''
Gets all genes for a group id (FBgg#)

(gene_group FBgg0001558)
(genes (gene_group FBgg0001558) FBgn0032464)
(genes (gene_group FBgg0001558) FBgn0263598)
(genes (gene_group FBgg0001558) FBgn0265262)
(genes (gene_group FBgg0001558) FBgn0032464)
(genes (gene_group FBgg0001558) FBgn0263598)
(genes (gene_group FBgg0001558) FBgn0265262)
(group_symbol (gene_group FBgg0001558) VHA-V1-CAT)
(group_name (gene_group FBgg0001558) VACUOLAR_ATPASE_V1_DOMAIN_CATALYTIC_SUBUNITS)
(parent_groups (gene_group FBgg0001558) FBgg0001577)
(parent_groups (gene_group FBgg0001558) FBgg0000073)
(taxon_id (gene_group FBgg0001558) 7227)
(source (gene_group FBgg0001558) FLYBASE)
(source_url (gene_group FBgg0001558) https://flybase.org/)
'''
def get_group_genes_fbgn(group_FBgg: str):
    return get_property_value("genes", "gene_group", group_FBgg)

    # q = {
    #     "atom_type": "link",
    #     "type": "Expression",
    #     "targets": [
    #         {"atom_type": "node", "type": "Symbol", "name": "genes"},
    #         {
    #             "atom_type": "link",
    #             "type": "Expression",
    #             "targets": [
    #                 {"atom_type": "node", "type": "Symbol", "name": "gene_group"},
    #                 {"atom_type": "node", "type": "Symbol", "name": group_FBgg} 
    #             ]
    #         },
    #         #{"atom_type": "node", "type": "Symbol", "name": "FBgn0032464"},
    #         {"atom_type": "variable", "name": "v1"},
    #     ]
    # }
    # answer = das.query(q)
    # fbgn_list = []
    # for result in answer:
    #     fbgn_list.append(result.subgraph['targets'][2]['name'])

    # return fbgn_list


'''
Gets groups ids (FBgg#) for a given gene (FBgn#)

(gene_group FBgg0001558)
(genes (gene_group FBgg0001558) FBgn0032464)
(genes (gene_group FBgg0001558) FBgn0263598)
(genes (gene_group FBgg0001558) FBgn0265262)
(genes (gene_group FBgg0001558) FBgn0032464)
(genes (gene_group FBgg0001558) FBgn0263598)
(genes (gene_group FBgg0001558) FBgn0265262)
(group_symbol (gene_group FBgg0001558) VHA-V1-CAT)
(group_name (gene_group FBgg0001558) VACUOLAR_ATPASE_V1_DOMAIN_CATALYTIC_SUBUNITS)
(parent_groups (gene_group FBgg0001558) FBgg0001577)
(parent_groups (gene_group FBgg0001558) FBgg0000073)
(taxon_id (gene_group FBgg0001558) 7227)
(source (gene_group FBgg0001558) FLYBASE)
(source_url (gene_group FBgg0001558) https://flybase.org/)
'''
def get_groups_for_gene(gene_id: str):
    q = {
        "atom_type": "link",
        "type": "Expression",
        "targets": [
            {"atom_type": "node", "type": "Symbol", "name": "genes"},
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "gene_group"},
                    {"atom_type": "variable", "name": "v1"},
                ]
            },
            {"atom_type": "node", "type": "Symbol", "name": gene_id},
            
        ]
    }
    answer = das.query(q)
    fbgn_list = []
    for result in answer:
        fbgn_list.append(result.subgraph['targets'][1]['targets'][1]['name'])

    return fbgn_list



four_tfs_symbols = ["Abd-B", "Clk", "Mef2", "Myc"]

print("\n\nStarted getting gene symbols (4 TFs)...")
four_tfs_ids = []
for gene_symbol in four_tfs_symbols:
    start = time.time()
    fbgn = get_FBgn(gene_symbol)
    four_tfs_ids.extend( fbgn )
    print(f"FBgn for {gene_symbol}: {fbgn[0]}" )
    finish = time.time()
    print(f'Answer time: {finish - start} sec.')

for fbgn, symbol in zip(four_tfs_ids, four_tfs_symbols):
    start = time.time()
    groups = get_groups_for_gene(fbgn)
    print(f'\n\nGroups for {symbol}:')    
    for grp in groups:
        query_property_name = "group_symbol"            # (group_symbol (gene_group FBgg0001558) VHA-V1-CAT)
        main_entity_type = "gene_group"
        group_symbol = get_property_value(query_property_name, main_entity_type, grp)
        query_property_name = "group_name"
        group_name = get_property_value(query_property_name, main_entity_type, grp)[0]
        print(f"Group symbol for {grp}: {group_symbol}")
        print(f"Group name for {grp}: {group_name.replace('_', ' ')}")
        grp_fbgns = get_group_genes_fbgn(grp)
        for bud_fbgn in grp_fbgns:
            bud_symbol = get_gene_symbol(bud_fbgn)
            if bud_symbol == []:
                #print(f'No gene symbol for {b_fbgn} in the Net_act DAS. Retrieving it from Flybase...')
                bud_symbol = get_symbol_from_flybase(bud_fbgn)[0] + " (from FB)"
            else:
                bud_symbol = bud_symbol[0]
            print(f'{symbol} buddies in group {grp}: {bud_fbgn} <--> {bud_symbol}')
    finish = time.time()
    print(f'Answer time (gene {symbol}): {finish - start} sec.')



# print("\n\nFunction to retrieve some property's values...")
# query_property_name = "group_symbol"            # (group_symbol (gene_group FBgg0001558) VHA-V1-CAT)
# main_entity_type = "gene_group"
# main_entity_id = "FBgg0000727"
# group_symbol = get_property_value(query_property_name, main_entity_type, main_entity_id)
# print(f"Group symbol for {main_entity_id}: {group_symbol}")
# query_property_name = "group_name"            # (group_name (gene_group FBgg0001558) VACUOLAR_ATPASE_V1_DOMAIN_CATALYTIC_SUBUNITS)
# main_entity_type = "gene_group"
# main_entity_id = "FBgg0000727"
# group_name = get_property_value(query_property_name, main_entity_type, main_entity_id)
# print(f"Group name for {main_entity_id}: {group_name}")



'''
Get GO term name     -----> this and queries like get_gene_name can be generalized

(go GO:0032922)
(term_name (go GO:0032922) circadian_regulation_of_gene_expression)
(synonyms (go GO:0032922) circadian_regulation_of_protein_expression)
(synonyms (go GO:0032922) diurnal_variation_of_gene_expression)
(synonyms (go GO:0032922) diurnal_variation_of_protein_expression)
(source (go GO:0032922) Gene_Ontology)
(source_url (go GO:0032922) http://purl.obolibrary.org/obo/go.owl)
(subontology (go GO:0032922) biological_process)
'''
def get_GO_term_name(go_id: str):
    return get_property_value("term_name", "go", go_id)

    # q = {
    #     "atom_type": "link",
    #     "type": "Expression",
    #     "targets": [
    #         {"atom_type": "node", "type": "Symbol", "name": "term_name"},
    #         {
    #             "atom_type": "link",
    #             "type": "Expression",
    #             "targets": [                
    #                 {"atom_type": "node", "type": "Symbol", "name": "go"},
    #                 {"atom_type": "node", "type": "Symbol", "name": go_id}
    #             ]
    #         },
    #         {"atom_type": "variable", "name": "v1"},
    #     ]
    # }
    # answer = das.query(q)
    # entity_list = []
    # for result in answer:
    #     entity_list.append(result.subgraph['targets'][2]["name"])

    # return entity_list


'''
Get all genes annotated to a given GO term

(belongs_to (gene FBgn0023076) (go GO:0032922))
(qualifier (belongs_to (gene FBgn0023076) (go GO:0032922)) involved_in)
(db_reference (belongs_to (gene FBgn0023076) (go GO:0032922)) FB:FBrf0237417)
(db_reference (belongs_to (gene FBgn0023076) (go GO:0032922)) PMID:29174887)
(evidence (belongs_to (gene FBgn0023076) (go GO:0032922)) IMP)
(taxon (belongs_to (gene FBgn0023076) (go GO:0032922)) 7227)
(source (belongs_to (gene FBgn0023076) (go GO:0032922)) GO)
(source_url (belongs_to (gene FBgn0023076) (go GO:0032922)) https://ftp.flybase.net/releases/current/precomputed_files/go/gene_association.fb.gz)
'''
def get_all_genes_for_GO_term(go_term_id: str):
    q = {
        "atom_type": "link",
        "type": "Expression",
        "targets": [
            {"atom_type": "node", "type": "Symbol", "name": "belongs_to"},
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "gene"},
                    {"atom_type": "variable", "name": "v1"},
                ]
            },
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "go"},          
                    {"atom_type": "node", "type": "Symbol", "name": go_term_id},                             
                ]
            },
                        
        ]
    }
    answer = das.query(q)
    fbgn_list = []
    for result in answer:
        fbgn_list.append(result.subgraph['targets'][1]['targets'][1]['name'])

    return fbgn_list


# start = time.time()
# go_term_id = "GO:0032922"
# fbgns = get_all_genes_for_GO_term(go_term_id)
# print(f'\n\nGenes ids for GO term {get_GO_term_name("GO:0032922")[0]}:')
# for fbgn in fbgns:
#     gene_symbol = get_gene_symbol(fbgn)
#     if gene_symbol != []:
#         print(f'GO term {go_term_id} annotated to {gene_symbol[0]}')
#     else:
#         bud_symbol = get_symbol_from_flybase(fbgn)
#         print(f'GO term {go_term_id} annotated to {bud_symbol}')
# finish = time.time()
# print(f'Answer time: {finish - start} sec.')


'''
Get all GO terms  annotated to a given gene (symbol)

(belongs_to (gene FBgn0023076) (go GO:0032922))
(qualifier (belongs_to (gene FBgn0023076) (go GO:0032922)) involved_in)
(db_reference (belongs_to (gene FBgn0023076) (go GO:0032922)) FB:FBrf0237417)
(db_reference (belongs_to (gene FBgn0023076) (go GO:0032922)) PMID:29174887)
(evidence (belongs_to (gene FBgn0023076) (go GO:0032922)) IMP)
(taxon (belongs_to (gene FBgn0023076) (go GO:0032922)) 7227)
(source (belongs_to (gene FBgn0023076) (go GO:0032922)) GO)
(source_url (belongs_to (gene FBgn0023076) (go GO:0032922)) https://ftp.flybase.net/releases/current/precomputed_files/go/gene_association.fb.gz)
'''
def get_all_GO_terms(fbgn: str):
    q = {
        "atom_type": "link",
        "type": "Expression",
        "targets": [
            {"atom_type": "node", "type": "Symbol", "name": "belongs_to"},
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "gene"},
                    {"atom_type": "node", "type": "Symbol", "name": fbgn}
                    #{"atom_type": "node", "type": "Symbol", "name": "FBgn0000015"},    "Abd-B"
                    #{"atom_type": "node", "type": "Symbol", "name": "FBgn0023076"},     # Clk
                ]
            },
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "go"},          
                    {"atom_type": "variable", "name": "v1"},
                ]
            },
                        
        ]
    }
    answer = das.query(q)
    fbgn_list = []
    for result in answer:
        fbgn_list.append(result.subgraph['targets'][2]['targets'][1]['name'])

    return fbgn_list



print(f'\n\nGene ontology terms...')
for gene_id, gene_symbol in zip(four_tfs_ids, four_tfs_symbols):
    start = time.time()
    go_ids = get_all_GO_terms(gene_id)
    for go_id in go_ids:
        print(f'\nTerm for {gene_symbol}: {get_GO_term_name(go_id)[0].replace("_", " ")}')
        fbgns = get_all_genes_for_GO_term(go_id)
        print(f'Genes for GO term:')
        for fbgn in fbgns:
            g_symbol = get_gene_symbol(fbgn)
            if g_symbol != []:
                print(f'\t\t{g_symbol[0]}')
            else:
                g_symbol = get_symbol_from_flybase(fbgn)
                print(f'\t\t{g_symbol}')
    finish = time.time()
    print(f'Answer time: {finish - start} sec.')


'''
Gets orthologs of a Fruit Fly gene (given by its FBgn). **** IT DOESN'T CHECK DIOPT_SCORE YET...

(orthologs_genes (gene FBgn0023076) (gene ENSG00000170485))
(hsa_hgnc_id (orthologs_genes (gene FBgn0023076) (gene ENSG00000170485)) HGNC:7895)
(hsa_omim_id (orthologs_genes (gene FBgn0023076) (gene ENSG00000170485)) MIM:603347)
(hsa_hgnc_symbol (orthologs_genes (gene FBgn0023076) (gene ENSG00000170485)) NPAS2)
(DIOPT_score (orthologs_genes (gene FBgn0023076) (gene ENSG00000170485)) 10)
(source_organism (orthologs_genes (gene FBgn0023076) (gene ENSG00000170485)) Drosophila_melanogaster)
(target_organism (orthologs_genes (gene FBgn0023076) (gene ENSG00000170485)) Homo_sapiens)
'''
def get_all_FB_orthologs(fbgn: str):
    q = {
        "atom_type": "link",
        "type": "Expression",
        "targets": [
            {"atom_type": "node", "type": "Symbol", "name": "orthologs_genes"},
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "gene"},
                    {"atom_type": "node", "type": "Symbol", "name": fbgn}
                    #{"atom_type": "node", "type": "Symbol", "name": "FBgn0000015"},    "Abd-B"
                    #{"atom_type": "node", "type": "Symbol", "name": "FBgn0023076"},     # Clk
                ]
            },
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "gene"},          
                    {"atom_type": "variable", "name": "v1"},
                ]
            },
                        
        ]
    }
    answer = das.query(q)
    fbgn_list = []
    for result in answer:
        fbgn_list.append(result.subgraph['targets'][2]['targets'][1]['name'])

    return fbgn_list

print('\n\nOrthologous...\n')
# print(four_tfs_ids)
# print(four_tfs_symbols)
for gene_id, gene_symbol in zip(four_tfs_ids, four_tfs_symbols):
    start = time.time()
    ensembl_ids = set( get_all_FB_orthologs(gene_id))
    for ensembl_id in ensembl_ids:
        print(f'Human ortholog for {gene_symbol}: {ensembl_id}')
    finish = time.time()
    print(f'Answer time: {finish - start} sec.')



'''
Gets all paralogs of a gene.    **** IT DOESN'T CHECK DIOPT_SCORE YET...

(paralogs_genes (gene FBgn0023076) (gene FBgn0002723))
(source_symbol (paralogs_genes (gene FBgn0023076) (gene FBgn0002723)) Clk)
(target_symbol (paralogs_genes (gene FBgn0023076) (gene FBgn0002723)) Met)
(DIOPT_score (paralogs_genes (gene FBgn0023076) (gene FBgn0002723)) 3)
(taxon_id (paralogs_genes (gene FBgn0023076) (gene FBgn0002723)) 7227)
'''
def get_all_FB_paralogs(fbgn: str):
    q = {
        "atom_type": "link",
        "type": "Expression",
        "targets": [
            {"atom_type": "node", "type": "Symbol", "name": "paralogs_genes"},
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "gene"},
                    {"atom_type": "node", "type": "Symbol", "name": fbgn}
                    #{"atom_type": "node", "type": "Symbol", "name": "FBgn0000015"},    "Abd-B"
                    #{"atom_type": "node", "type": "Symbol", "name": "FBgn0023076"},     # Clk
                ]
            },
            {
                "atom_type": "link",
                "type": "Expression",
                "targets": [
                    {"atom_type": "node", "type": "Symbol", "name": "gene"},          
                    {"atom_type": "variable", "name": "v1"},
                ]
            },
                        
        ]
    }
    answer = das.query(q)
    fbgn_list = []
    for result in answer:
        fbgn_list.append(result.subgraph['targets'][2]['targets'][1]['name'])

    return fbgn_list
    

print('\n\nParalogs...\n"')
for gene_id, gene_symbol in zip(four_tfs_ids, four_tfs_symbols):
    start = time.time()
    fbgns = set( get_all_FB_paralogs(gene_id))
    for fbgn in fbgns:
        g_symbol = get_gene_symbol(fbgn)
        if g_symbol != []:
                print(f'Paralog for {gene_symbol}: {fbgn} ({g_symbol[0]})')
        else:
            g_symbol = get_symbol_from_flybase(fbgn)
        print(f'FB paralog for {gene_symbol}: {fbgn} ({g_symbol})')
    finish = time.time()
    print(f'Answer time: {finish - start} sec.')




# To be done...

'''
Gets all genes connected to a given gene_id (FBgn#)
'''

'''
(genes_pathways (gene ENSG00000000938) (pathway R-HSA-9664417))

(pathway R-HSA-9664417)
(pathway_name (pathway R-HSA-9664417) Leishmania_phagocytosis)


'''
#four_tf_gene_list = ["Abd-B", "Clk", "Mef2", "Myc"]
#for gene_ymbol in four_tf_gene_list:
